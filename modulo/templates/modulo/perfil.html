{% extends 'modulo/base.html' %}
{% block title %}Mi Perfil{% endblock %}

{% block content %}
<h2 class="mb-4">Mi Perfil - {{ user.username }}</h2>

<h4>‚ûï Agregar Nuevo Libro:</h4>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ agregar_libro_form.as_p }}
    <button type="submit" class="btn btn-primary" name="agregar_libro">Guardar Libro</button>
</form>

<hr class="my-4">

<h4>üìö Mis Libros Creados:</h4>
<div class="row">
    {% for libro_usuario in libros_usuario %}
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                {% if libro_usuario.portada %}
                    <img src="{{ libro_usuario.portada.url }}" class="card-img-top" style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ libro_usuario.titulo }}</h5>
                    <p class="card-text">{{ libro_usuario.autor }}</p>
                    {% if libro_usuario.descripcion %}
                        <p class="card-text">{{ libro_usuario.descripcion|truncatewords:20 }}</p>
                    {% endif %}
                    {% if libro_usuario.link %}
                        <a href="{{ libro_usuario.link }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver online</a>
                    {% else %}
                        <p class="text-muted">Sin enlace</p>
                    {% endif %}
                    <a href="{% url 'comentarios_libro' titulo_slug=libro_usuario.slug_titulo autor_slug=libro_usuario.slug_autor %}"
                       class="btn btn-warning btn-sm position-relative mt-2">
                        <i class="bi bi-chat-dots"></i> Comentar
                        {% if libro_usuario.comentarios_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                                {{ libro_usuario.comentarios_count }}
                            </span>
                        {% endif %}
                    </a>
                    {# Aqu√≠ podr√≠as a√±adir enlaces para editar/eliminar tus propios libros si lo implementas #}
                </div>
            </div>
        </div>
    {% empty %}
        <p>No has creado ning√∫n libro a√∫n.</p>
    {% endfor %}
</div>

<hr class="my-4">

<h4>‚≠ê Libros guardados:</h4>
<div class="row">
    {% for libro in favoritos %}
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                {% if libro.portada %}
                    <img src="{{ libro.portada }}" class="card-img-top" style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ libro.titulo }}</h5>
                    <p class="card-text">{{ libro.autor }}</p>
                    <a href="{{ libro.link }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver online</a>
                    <a href="{% url 'eliminar_libro' libro.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                    <a href="{% url 'comentarios_libro' titulo_slug=libro.titulo|slugify autor_slug=libro.autor|slugify %}"
                       class="btn btn-warning btn-sm position-relative mt-2">
                        <i class="bi bi-chat-dots"></i> Comentar
                        {% if libro.num_comentarios > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                                {{ libro.num_comentarios }}
                            </span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    {% empty %}
        <p>No tienes libros guardados a√∫n.</p>
    {% endfor %}
</div>

<hr class="my-4">

<h4>üîç Historial de b√∫squedas:</h4>
<ul class="list-group">
    {% for h in historial %}
        <li class="list-group-item">
            {{ h.termino }}
            <span class="text-muted float-end">{{ h.fecha|date:"SHORT_DATETIME_FORMAT" }}</span>
        </li>
    {% empty %}
        <li class="list-group-item">No hay b√∫squedas recientes.</li>
    {% endfor %}
</ul>
{% endblock %}

